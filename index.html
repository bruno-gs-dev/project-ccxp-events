<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CCXP Activations App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Custom Config for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Smooth fade in */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Pull to refresh container transition */
        #ptr-indicator {
            transition: transform 0.2s ease-out;
        }

        /* Slide up modal animation */
        .modal-enter {
            animation: slideUp 0.3s ease-out forwards;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans selection:bg-indigo-500/30 pb-20 overscroll-none">

    <!-- Pull to Refresh Indicator -->
    <div id="ptr-indicator" class="fixed top-0 left-0 w-full z-50 pointer-events-none flex justify-center items-center" style="transform: translateY(-60px);">
        <div class="bg-slate-800/90 backdrop-blur text-white p-2 rounded-full shadow-lg border border-slate-700 flex items-center justify-center">
            <i id="ptr-icon" class="ph ph-arrows-clockwise text-slate-400 text-xl"></i>
            <i id="ptr-spinner" class="ph ph-spinner animate-spin text-indigo-400 text-xl hidden"></i>
        </div>
    </div>

    <!-- Header Sticky -->
    <div class="sticky top-0 z-40 bg-slate-950/80 backdrop-blur-md border-b border-white/10 transition-all duration-300" id="main-header">
        <div class="px-4 py-3">
            <!-- Top Bar -->
            <div class="flex items-center justify-between mb-3">
                <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
                    Ativações CCXP
                </h1>
                <div class="flex items-center gap-2">
                    <span id="loading-indicator" class="text-xs text-slate-500 animate-pulse hidden">Atualizando...</span>
                    <span id="count-badge" class="text-xs font-medium text-slate-500 bg-slate-900 px-2 py-1 rounded-full border border-slate-800">
                        0 itens
                    </span>
                </div>
            </div>

            <!-- Search & Filter Toggle -->
            <div class="flex gap-2">
                <div class="relative flex-1">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-lg"></i>
                    <input 
                        type="text" 
                        id="search-input"
                        placeholder="Buscar..." 
                        class="w-full bg-slate-900 border border-slate-800 text-slate-200 text-sm rounded-xl py-2.5 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all placeholder:text-slate-600"
                    >
                </div>
                <button id="filter-toggle-btn" class="p-2.5 rounded-xl border bg-slate-900 border-slate-800 text-slate-400 hover:text-white transition-all">
                    <i class="ph ph-faders text-xl"></i>
                </button>
            </div>

            <!-- Quick Type Filters (Horizontal Scroll) -->
            <div id="quick-filters-container" class="flex gap-2 overflow-x-auto mt-3 pb-1 no-scrollbar">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Expanded Filters Drawer (Hidden by default) -->
        <div id="filter-drawer" class="hidden px-4 pb-4 fade-in">
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800 space-y-3">
                <div>
                    <label id="filter-label" class="text-xs font-semibold text-slate-500 uppercase mb-2 block">Filtrar por Marca</label>
                    <select id="brand-select" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-2 text-sm text-slate-300 focus:outline-none focus:border-indigo-500">
                        <option value="Todas">Todas</option>
                        <!-- Options injected via JS -->
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="flex border-b border-slate-800 bg-slate-950/50 backdrop-blur-sm sticky top-[125px] z-30" id="tabs-nav">
        <button 
            onclick="switchTab('activations')"
            id="tab-activations"
            class="flex-1 py-3 text-sm font-medium border-b-2 border-indigo-500 text-indigo-400 transition-colors flex items-center justify-center gap-2"
        >
            <i class="ph ph-star text-lg"></i> Ativações
        </button>
        <button 
            onclick="switchTab('gifts')"
            id="tab-gifts"
            class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-300 transition-colors flex items-center justify-center gap-2"
        >
            <i class="ph ph-gift text-lg"></i> Brindes
        </button>
        <button 
            onclick="switchTab('lineup')"
            id="tab-lineup"
            class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-300 transition-colors flex items-center justify-center gap-2"
        >
            <i class="ph ph-calendar-blank text-lg"></i> Line-up
        </button>
    </div>

    <!-- Main Content Grid -->
    <div id="content-area" class="p-4 space-y-4 min-h-[50vh]">
        <!-- Cards injected via JS -->
        <div class="text-center py-20 opacity-50">
            <i class="ph ph-spinner animate-spin text-4xl mx-auto mb-4 text-slate-600"></i>
            <p class="text-lg font-medium">Carregando...</p>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="modal-overlay" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center hidden pointer-events-none">
        <!-- Backdrop -->
        <div 
            class="absolute inset-0 bg-black/70 backdrop-blur-sm pointer-events-auto transition-opacity opacity-0" 
            id="modal-backdrop"
            onclick="closeModal()"
        ></div>

        <!-- Modal Content -->
        <div id="modal-content" class="relative w-full sm:w-[500px] h-[90vh] sm:h-[80vh] bg-slate-900 rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col pointer-events-auto transform translate-y-full transition-transform duration-300">
            
            <!-- Header Image Area -->
            <div id="modal-header-bg" class="relative h-32 bg-slate-700 flex items-center justify-center shrink-0">
                <button 
                    onclick="closeModal()"
                    class="absolute top-4 right-4 p-2 bg-black/20 hover:bg-black/40 rounded-full text-white transition-colors z-10"
                >
                    <i class="ph ph-x text-xl"></i>
                </button>
                <div id="modal-brand-display" class="flex items-center justify-center w-full h-full p-4">
                    <!-- Brand Image or Text injected here -->
                </div>
            </div>

            <!-- Content Scrollable Area -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-900" id="modal-body">
                <div>
                    <h2 id="modal-title" class="text-2xl font-bold text-white leading-tight mb-2"></h2>
                    <div id="modal-tags" class="flex flex-wrap gap-2 mt-3">
                        <!-- Tags injected here -->
                    </div>
                </div>

                <!-- Q&A Section -->
                <div id="modal-qa-list" class="space-y-4">
                    <!-- Q&A Items injected here -->
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="p-4 bg-slate-900 border-t border-slate-800 flex gap-3 shrink-0">
                <button class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl transition-all active:scale-95 flex items-center justify-center gap-2">
                    <i class="ph ph-map-pin text-xl"></i>
                    Localizar
                </button>
                <button class="p-3 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl transition-all active:scale-95">
                    <i class="ph ph-share-network text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const API_URL = "https://typesense.ccxp.com.br/multi_search?x-typesense-api-key=87UE3dBtOyjJpNU4TJIo4KOMiiasac93";
        
        // Payload base para Ativações
        const ACTIVATIONS_PAYLOAD = {
            "query_by": "title, slug, brand, types, questionsAndAnswers, schedules",
            "query_by_weights": "100, 80, 50, 30, 80, 40",
            "highlight_fields": "title, brand, schedules",
            "per_page": 250,
            "facet_by": "brand,schedules,types",
            "exhaustive_search": true,
            "highlight_full_fields": "title, slug, brand, types, questionsAndAnswers, schedules",
            "collection": "activations",
            "q": "*",
            "filter_by": "locale:pt-br",
            "max_facet_values": 50,
            "page": 1
        };

        // Payload base para Line-ups (ATUALIZADO)
        const LINEUP_PAYLOAD = {
            "query_by": "title, bio, categories, days, workGender, local, publishedAtString",
            "query_by_weights": "12, 5, 3, 1, 1, 1, 1",
            "highlight_fields": "title",
            "per_page": 40,
            "facet_by": "categories,days,letter,local,workGender",
            "max_candidates": 4,
            "exhaustive_search": true,
            "sort_by": "_text_match:desc,title:asc",
            "highlight_full_fields": "title, bio, categories, days, workGender, local, publishedAtString",
            "collection": "line_ups",
            "q": "*",
            "filter_by": "locale:pt-br",
            "max_facet_values": 40,
            "page": 1
        };

        // Fallback de Ativações
        const RAW_DATA_FALLBACK = {
            "results": [{ "facet_counts": [], "found": 0, "hits": [] }]
        };

        // Fallback de Line-up (Mock) para visualização
        const RAW_LINEUP_FALLBACK = {
            "results": [{
                "facet_counts": [
                    {
                        "counts": [
                            { "count": 5, "value": "Palco Thunder by Cinemark Club" },
                            { "count": 3, "value": "Palco Omelete" }
                        ],
                        "field_name": "local"
                    }
                ],
                "found": 2,
                "hits": [
                    {
                        "document": {
                            "title": "Painel de Abertura: O Futuro do Cinema",
                            "days": ["2025-12-04"],
                            "local": "Palco Thunder by Cinemark Club",
                            "bio": "Grandes diretores discutem o que esperar dos próximos anos.",
                            "image": "https://ccxp-production-files.s3.amazonaws.com/CCXP_23_Thumb_Palcos_Thunder_01_882c9c270f.jpg",
                            "brand": "CCXP"
                        }
                    },
                    {
                        "document": {
                            "title": "Showcase: Paramount Pictures",
                            "days": ["2025-12-05"],
                            "local": "Palco Omelete",
                            "bio": "Novidades exclusivas e trailers inéditos.",
                            "image": "https://ccxp-production-files.s3.amazonaws.com/CCXP_23_Thumb_Palcos_Omelete_01_4b8b8b8b8b.jpg",
                            "brand": "Paramount"
                        }
                    }
                ]
            }]
        };

        const BRAND_COLORS = {
            'Amazon Prime': 'bg-blue-600',
            'Netflix': 'bg-red-600',
            'Warner Bros. Pictures': 'bg-blue-800',
            'HBO Max': 'bg-purple-700',
            'Red Bull': 'bg-blue-900',
            'Petrobras': 'bg-green-600',
            'Sanrio': 'bg-pink-500',
            'Palco Thunder': 'bg-yellow-600',
            'Default': 'bg-slate-700'
        };

        const GIFT_KEYWORDS = ['brinde', 'prêmio', 'ganhar', 'colecionável', 'poster', 'pôster', 'copo', 'tirante', 'pin', 'botton', 'adesivo', 'foto impressa', 'recompensa'];

        // --- STATE MANAGEMENT ---
        const state = {
            activationsData: RAW_DATA_FALLBACK, // Cache for activations
            lineupData: RAW_LINEUP_FALLBACK,    // Cache for lineup
            activeTab: 'activations',           // 'activations' | 'gifts' | 'lineup'
            search: '',
            selectedBrand: 'Todas',
            selectedType: 'Todos',
            showFilters: false,
            loading: false,
            pullY: 0,
            isRefreshing: false,
            startY: 0
        };

        // --- DOM ELEMENTS ---
        const els = {
            contentArea: document.getElementById('content-area'),
            searchInput: document.getElementById('search-input'),
            countBadge: document.getElementById('count-badge'),
            filterToggleBtn: document.getElementById('filter-toggle-btn'),
            filterDrawer: document.getElementById('filter-drawer'),
            filterLabel: document.getElementById('filter-label'),
            brandSelect: document.getElementById('brand-select'),
            quickFilters: document.getElementById('quick-filters-container'),
            tabActivations: document.getElementById('tab-activations'),
            tabGifts: document.getElementById('tab-gifts'),
            tabLineup: document.getElementById('tab-lineup'),
            ptrIndicator: document.getElementById('ptr-indicator'),
            ptrIcon: document.getElementById('ptr-icon'),
            ptrSpinner: document.getElementById('ptr-spinner'),
            loadingIndicator: document.getElementById('loading-indicator'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalBackdrop: document.getElementById('modal-backdrop'),
            modalContent: document.getElementById('modal-content'),
            modalHeaderBg: document.getElementById('modal-header-bg'),
            modalBrandDisplay: document.getElementById('modal-brand-display'),
            modalTitle: document.getElementById('modal-title'),
            modalTags: document.getElementById('modal-tags'),
            modalQaList: document.getElementById('modal-qa-list')
        };

        // --- INITIALIZATION ---
        async function init() {
            attachEventListeners();
            await fetchData(); // Initial fetch (activations)
        }

        function attachEventListeners() {
            // Search
            els.searchInput.addEventListener('input', (e) => {
                state.search = e.target.value;
                render();
            });

            // Filter Toggle
            els.filterToggleBtn.addEventListener('click', () => {
                state.showFilters = !state.showFilters;
                els.filterDrawer.classList.toggle('hidden', !state.showFilters);
                if (state.showFilters) {
                    els.filterToggleBtn.classList.add('bg-indigo-600', 'border-indigo-500', 'text-white');
                    els.filterToggleBtn.classList.remove('bg-slate-900', 'border-slate-800', 'text-slate-400');
                } else {
                    els.filterToggleBtn.classList.remove('bg-indigo-600', 'border-indigo-500', 'text-white');
                    els.filterToggleBtn.classList.add('bg-slate-900', 'border-slate-800', 'text-slate-400');
                }
            });

            // Brand/Stage Select
            els.brandSelect.addEventListener('change', (e) => {
                state.selectedBrand = e.target.value;
                render();
            });

            // Pull to Refresh (Touch Events)
            document.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
        }

        // --- DATA FETCHING ---
        async function fetchData() {
            state.loading = true;
            updateLoadingUI();

            // Decide which payload to use based on active tab
            const isLineup = state.activeTab === 'lineup';
            const currentPayload = isLineup ? LINEUP_PAYLOAD : ACTIVATIONS_PAYLOAD;
            
            // Update query string if searching
            currentPayload.q = state.search || "*";

            const payload = { "searches": [currentPayload] };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('API Error');
                const result = await response.json();
                
                if (result && result.results) {
                    if (isLineup) {
                        state.lineupData = result;
                    } else {
                        state.activationsData = result;
                    }
                    populateFilters(); // Update filters based on new data
                }
            } catch (error) {
                console.error("Usando dados de fallback devido a erro na API ou coleção inexistente:", error);
                // Fallback data is already in state, so we just carry on
            } finally {
                state.loading = false;
                state.isRefreshing = false;
                updateLoadingUI();
                render();
                
                // Reset Pull to Refresh UI
                els.ptrIndicator.style.transform = 'translateY(-60px)';
                els.ptrIcon.classList.remove('hidden');
                els.ptrSpinner.classList.add('hidden');
            }
        }

        function updateLoadingUI() {
            if (state.loading && !state.isRefreshing) {
                els.loadingIndicator.classList.remove('hidden');
            } else {
                els.loadingIndicator.classList.add('hidden');
            }
        }

        // --- PULL TO REFRESH LOGIC ---
        function handleTouchStart(e) {
            if (window.scrollY === 0) {
                state.startY = e.touches[0].clientY;
            }
        }

        function handleTouchMove(e) {
            if (window.scrollY === 0 && state.startY > 0) {
                const currentY = e.touches[0].clientY;
                if (currentY > state.startY) {
                    const diff = currentY - state.startY;
                    state.pullY = Math.min(diff * 0.5, 120);
                    if (state.pullY > 0) {
                        e.preventDefault();
                        els.ptrIndicator.style.transform = `translateY(${state.pullY - 40}px)`;
                        els.ptrIcon.style.transform = `rotate(${state.pullY * 2}deg)`;
                    }
                }
            }
        }

        async function handleTouchEnd() {
            if (state.pullY > 80) {
                state.isRefreshing = true;
                els.ptrIndicator.style.transform = `translateY(40px)`;
                els.ptrIcon.classList.add('hidden');
                els.ptrSpinner.classList.remove('hidden');
                await fetchData();
            } else {
                els.ptrIndicator.style.transform = `translateY(-60px)`;
            }
            state.startY = 0;
            state.pullY = 0;
        }

        // --- FILTERS & DATA PROCESSING ---
        function populateFilters() {
            const isLineup = state.activeTab === 'lineup';
            const currentData = isLineup ? state.lineupData : state.activationsData;
            const rawFacets = currentData.results[0]?.facet_counts || [];
            
            // Primary Filter: Brand (Activations) or Local (Lineup)
            const fieldName = isLineup ? 'local' : 'brand';
            const labelText = isLineup ? 'Filtrar por Local' : 'Filtrar por Marca';
            
            const items = rawFacets.find(f => f.field_name === fieldName)?.counts || [];
            
            els.filterLabel.textContent = labelText;
            els.brandSelect.innerHTML = '<option value="Todas">Todos</option>';
            
            items.forEach(b => {
                const option = document.createElement('option');
                option.value = b.value;
                option.textContent = `${b.value} (${b.count})`;
                els.brandSelect.appendChild(option);
            });

            // Quick Filters (Types) - Only relevant for Activations/Gifts
            if (!isLineup) {
                const types = rawFacets.find(f => f.field_name === 'types')?.counts || [];
                els.quickFilters.innerHTML = '';
                
                const allBtn = createQuickFilterBtn('Todos', state.selectedType === 'Todos');
                allBtn.onclick = () => { state.selectedType = 'Todos'; render(); };
                els.quickFilters.appendChild(allBtn);

                types.forEach(t => {
                    const btn = createQuickFilterBtn(t.value, state.selectedType === t.value);
                    btn.onclick = () => { 
                        state.selectedType = (state.selectedType === t.value) ? 'Todos' : t.value; 
                        render(); 
                    };
                    els.quickFilters.appendChild(btn);
                });
                els.quickFilters.style.display = 'flex';
            } else {
                els.quickFilters.style.display = 'none';
            }
        }

        function createQuickFilterBtn(label, isActive) {
            const btn = document.createElement('button');
            btn.textContent = label;
            btn.className = `whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-medium transition-colors border ${
                isActive 
                ? 'bg-indigo-600 text-white border-indigo-500' 
                : 'bg-slate-900 text-slate-400 border-slate-800'
            }`;
            return btn;
        }

        function extractGiftInfo(qaList) {
            if (!qaList) return null;
            for (const item of qaList) {
                if (item.answer) {
                    const lower = item.answer.toLowerCase();
                    if (GIFT_KEYWORDS.some(k => lower.includes(k))) return item.answer;
                }
            }
            return null;
        }

        function getFilteredItems() {
            const isLineup = state.activeTab === 'lineup';
            const currentData = isLineup ? state.lineupData : state.activationsData;
            const hits = currentData.results[0]?.hits || [];
            const term = state.search.toLowerCase();

            return hits.filter(hit => {
                const doc = hit.document;
                
                if (isLineup) {
                    const matchesSearch = (doc.title || "").toLowerCase().includes(term) || 
                                          (doc.bio || "").toLowerCase().includes(term);
                    const matchesStage = state.selectedBrand === 'Todas' || doc.local === state.selectedBrand;
                    return matchesSearch && matchesStage;
                }
                else if (state.activeTab === 'gifts') {
                    const giftText = extractGiftInfo(doc.questionsAndAnswers);
                    if (!giftText) return false;
                    hit.giftText = giftText; 
                    return doc.title.toLowerCase().includes(term) || 
                           doc.brand.toLowerCase().includes(term) ||
                           giftText.toLowerCase().includes(term);
                } else {
                    // Activations
                    const matchesSearch = doc.title.toLowerCase().includes(term) || 
                                          doc.brand.toLowerCase().includes(term);
                    const matchesBrand = state.selectedBrand === 'Todas' || doc.brand === state.selectedBrand;
                    const matchesType = state.selectedType === 'Todos' || doc.types?.includes(state.selectedType);
                    return matchesSearch && matchesBrand && matchesType;
                }
            });
        }

        // --- RENDERING ---
        function switchTab(tab) {
            const prevTab = state.activeTab;
            state.activeTab = tab;
            state.selectedBrand = 'Todas';
            state.selectedType = 'Todos';
            
            // Update Classes
            const activeClass = "border-indigo-500 text-indigo-400";
            const inactiveClass = "border-transparent text-slate-500 hover:text-slate-300";
            const activeGiftClass = "border-pink-500 text-pink-400";
            const activeLineupClass = "border-orange-500 text-orange-400";

            els.tabActivations.className = `flex-1 py-3 text-sm font-medium border-b-2 transition-colors flex items-center justify-center gap-2 ${tab === 'activations' ? activeClass : inactiveClass}`;
            els.tabGifts.className = `flex-1 py-3 text-sm font-medium border-b-2 transition-colors flex items-center justify-center gap-2 ${tab === 'gifts' ? activeGiftClass : inactiveClass}`;
            els.tabLineup.className = `flex-1 py-3 text-sm font-medium border-b-2 transition-colors flex items-center justify-center gap-2 ${tab === 'lineup' ? activeLineupClass : inactiveClass}`;

            // UI Toggles based on tab
            if (tab === 'activations') {
                els.filterToggleBtn.style.display = 'block';
                els.searchInput.placeholder = "Buscar ativação...";
            } else if (tab === 'gifts') {
                els.filterToggleBtn.style.display = 'none';
                els.filterDrawer.classList.add('hidden');
                els.searchInput.placeholder = "Buscar brindes...";
            } else {
                // Lineup
                els.filterToggleBtn.style.display = 'block';
                els.searchInput.placeholder = "Buscar painel...";
            }

            // If switching between activation/gifts and lineup, we need to re-populate filters and maybe fetch
            const wasLineup = prevTab === 'lineup';
            const isLineup = tab === 'lineup';

            if (wasLineup !== isLineup) {
                fetchData(); // Fetch new collection
            } else {
                render(); // Just re-render if same data source
            }
        }

        function render() {
            const items = getFilteredItems();
            els.countBadge.textContent = `${items.length} itens`;
            els.contentArea.innerHTML = '';

            if (state.activeTab === 'activations') populateFilters(); // Refresh quick filters state

            if (items.length === 0) {
                let icon = 'star';
                if (state.activeTab === 'gifts') icon = 'gift';
                if (state.activeTab === 'lineup') icon = 'calendar-x';

                els.contentArea.innerHTML = `
                    <div class="text-center py-20 opacity-50 fade-in">
                        <i class="ph ph-${icon} text-5xl mx-auto mb-4 text-slate-600 block"></i>
                        <p class="text-lg font-medium">Nenhum item encontrado</p>
                        <p class="text-sm">Tente mudar a busca ou filtros</p>
                    </div>
                `;
                return;
            }

            items.forEach(hit => {
                let card;
                if (state.activeTab === 'lineup') card = createLineupCard(hit);
                else if (state.activeTab === 'gifts') card = createGiftCard(hit);
                else card = createActivationCard(hit);
                
                els.contentArea.appendChild(card);
            });
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function createLineupCard(hit) {
            const doc = hit.document;
            const div = document.createElement('div');
            div.className = "bg-slate-900/80 border-l-4 border-orange-500 rounded-r-xl p-4 mb-3 relative group overflow-hidden fade-in shadow-sm";
            div.onclick = () => openModal(hit);

            // Time handling is simplified since new payload doesn't explicitly list start_date field in selection
            // We'll use 'days' or publishedAtString for now or just generic
            const dayDisplay = doc.days ? doc.days.join(', ') : (doc.start_date ? formatTime(doc.start_date) : 'Data a confirmar');

            div.innerHTML = `
                <div class="flex flex-col gap-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-orange-400 uppercase tracking-wide flex items-center gap-1">
                            <i class="ph ph-clock"></i> ${dayDisplay}
                        </span>
                        <span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded uppercase border border-slate-700">
                            ${doc.local || doc.stage_title || 'Palco'}
                        </span>
                    </div>
                    <h2 class="text-base font-bold text-white leading-snug pr-4">${doc.title}</h2>
                    <p class="text-sm text-slate-400 line-clamp-2 mt-1">${doc.bio || doc.description || ''}</p>
                </div>
                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-700 group-hover:text-orange-500 transition-colors">
                    <i class="ph ph-caret-right text-xl"></i>
                </div>
            `;
            return div;
        }

        function createActivationCard(hit) {
            const doc = hit.document;
            const div = document.createElement('div');
            div.className = "bg-slate-900/50 border border-slate-800/50 rounded-2xl p-4 active:scale-[0.98] transition-all hover:bg-slate-900 hover:border-indigo-500/30 cursor-pointer relative group overflow-hidden fade-in";
            div.onclick = () => openModal(hit);

            const logoUrl = doc.brandImage || '';
            const logoContent = logoUrl 
                ? `<img src="${logoUrl}" alt="${doc.brand}" class="w-full h-full object-contain rounded-full">`
                : `<div class="w-full h-full bg-slate-700 flex items-center justify-center text-xs text-center font-bold">${doc.brand ? doc.brand.substring(0,2) : 'CC'}</div>`;

            const typesHtml = doc.types ? `<span class="inline-flex items-center px-2 py-0.5 rounded-md bg-slate-800 text-slate-300 border border-slate-700">${formatTypes(doc.types)}</span>` : '';
            const calendarIcon = doc.schedules?.includes("Sim, via site") ? '<i class="ph ph-calendar-check text-emerald-400"></i>' : '';

            div.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="w-14 h-14 rounded-full bg-slate-800 border-2 border-slate-700 flex-shrink-0 overflow-hidden p-1">
                        ${logoContent}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h3 class="text-sm font-semibold text-indigo-400 mb-0.5 truncate pr-2">${doc.brand || 'Marca'}</h3>
                            ${calendarIcon}
                        </div>
                        <h2 class="text-base font-bold text-white leading-tight mb-2 line-clamp-2">${doc.title}</h2>
                        <div class="flex items-center gap-2 text-xs text-slate-400">
                            ${typesHtml}
                        </div>
                    </div>
                    <div class="self-center text-slate-600 group-hover:text-indigo-400 transition-colors">
                        <i class="ph ph-caret-right text-xl"></i>
                    </div>
                </div>
            `;
            return div;
        }

        function createGiftCard(hit) {
            const doc = hit.document;
            const div = document.createElement('div');
            div.className = "bg-gradient-to-br from-slate-900 to-slate-900/50 border border-pink-500/20 rounded-2xl p-4 active:scale-[0.98] transition-all hover:border-pink-500/40 cursor-pointer relative group fade-in";
            div.onclick = () => openModal(hit);

            const logoContent = doc.brandImage 
                ? `<img src="${doc.brandImage}" alt="${doc.brand}" class="w-full h-full object-contain rounded-full">`
                : `<div class="w-full h-full bg-slate-700 flex items-center justify-center text-xs text-center font-bold">${doc.brand ? doc.brand.substring(0,2) : 'CC'}</div>`;

            div.innerHTML = `
                <div class="absolute top-3 right-3">
                    <i class="ph ph-gift text-pink-500 text-lg"></i>
                </div>
                <div class="flex items-start gap-3 mb-3">
                    <div class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex-shrink-0 overflow-hidden p-1">
                        ${logoContent}
                    </div>
                    <div>
                        <h3 class="text-xs font-semibold text-slate-400">${doc.brand}</h3>
                        <h2 class="text-sm font-bold text-white line-clamp-1">${doc.title}</h2>
                    </div>
                </div>
                <div class="bg-pink-500/10 rounded-xl p-3 border border-pink-500/10">
                    <p class="text-sm text-pink-200 line-clamp-4 leading-relaxed">"${hit.giftText}"</p>
                </div>
                <div class="mt-2 text-right">
                    <span class="text-xs text-pink-400 font-medium">Ver detalhes</span>
                </div>
            `;
            return div;
        }

        function formatTypes(types) {
            if (!types || types.length === 0) return '';
            if (types.length <= 2) return types.join(' • ');
            return `${types[0]} +${types.length - 1}`;
        }

        // --- MODAL ---
        function openModal(hit) {
            const doc = hit.document;
            let brandColor = BRAND_COLORS['Default'];
            
            // Tentar encontrar cor pela marca ou pelo palco
            if (doc.brand && BRAND_COLORS[doc.brand]) brandColor = BRAND_COLORS[doc.brand];
            if (doc.stage_title && doc.stage_title.includes('Thunder')) brandColor = BRAND_COLORS['Palco Thunder'];

            // Header
            els.modalHeaderBg.className = `relative h-32 ${brandColor} flex items-center justify-center shrink-0`;
            
            // Image Logic
            let imageHtml = '';
            if (doc.brandImage) {
                imageHtml = `<img src="${doc.brandImage}" class="h-20 w-auto object-contain drop-shadow-lg">`;
            } else if (doc.image) {
                imageHtml = `<img src="${doc.image}" class="w-full h-full object-cover opacity-80">`;
                els.modalHeaderBg.classList.add('overflow-hidden'); // Ensure cover image clips
            } else {
                imageHtml = `<h2 class="text-2xl font-bold text-white">${doc.brand || doc.local || doc.stage_title || 'Detalhes'}</h2>`;
            }
            els.modalBrandDisplay.innerHTML = imageHtml;

            // Title & Tags
            els.modalTitle.textContent = doc.title;
            els.modalTags.innerHTML = '';
            
            // Tags logic varies by type
            if (doc.types) {
                doc.types.forEach(type => {
                    els.modalTags.innerHTML += `<span class="px-3 py-1 bg-indigo-500/20 text-indigo-300 text-xs font-medium rounded-full border border-indigo-500/30">${type}</span>`;
                });
            }
            
            if (doc.local || doc.stage_title) {
                 els.modalTags.innerHTML += `<span class="px-3 py-1 bg-orange-500/20 text-orange-300 text-xs font-medium rounded-full border border-orange-500/30">${doc.local || doc.stage_title}</span>`;
            }

            if (doc.schedules?.includes("Sim, via site")) {
                els.modalTags.innerHTML += `<span class="px-3 py-1 bg-emerald-500/20 text-emerald-300 text-xs font-medium rounded-full border border-emerald-500/30 flex items-center gap-1"><i class="ph ph-calendar"></i> Agendamento</span>`;
            }

            // Content / Q&A / Description
            els.modalQaList.innerHTML = '';
            
            // If it has a simple description or bio (Lineup), show it first
            if (doc.description || doc.bio) {
                 const descDiv = document.createElement('div');
                 descDiv.className = "text-slate-300 text-base leading-relaxed mb-4";
                 descDiv.textContent = doc.bio || doc.description;
                 els.modalQaList.appendChild(descDiv);
            }

            // Q&A Loop
            doc.questionsAndAnswers?.forEach(qa => {
                const div = document.createElement('div');
                div.className = "bg-slate-800/50 rounded-xl p-4 border border-slate-700";
                div.innerHTML = `
                    <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                        <i class="ph ph-info"></i>
                        ${qa.question.replace(':', '')}
                    </h3>
                    <p class="text-slate-300 text-sm leading-relaxed whitespace-pre-line">${qa.answer}</p>
                `;
                els.modalQaList.appendChild(div);
            });

            // Show Animation
            els.modalOverlay.classList.remove('hidden');
            void els.modalOverlay.offsetWidth; // Trigger reflow
            
            els.modalBackdrop.classList.remove('opacity-0');
            els.modalContent.classList.remove('translate-y-full');
            
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            els.modalBackdrop.classList.add('opacity-0');
            els.modalContent.classList.add('translate-y-full');

            setTimeout(() => {
                els.modalOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        // Run
        init();

    </script>
</body>
</html>
